{% extends "base.html" %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold mb-6">System-Updates</h1>
    
    <div class="bg-white rounded-lg shadow-lg p-6">
        <div class="mb-6">
            <h2 class="text-xl font-semibold mb-4">Update-Status</h2>
            <div id="update-status" class="p-4 rounded-lg bg-gray-100">
                <p class="text-gray-600">Prüfe auf Updates...</p>
            </div>
        </div>
        
        <div class="flex space-x-4">
            <button id="check-updates" 
                    class="btn btn-primary">
                <i class="fas fa-sync-alt mr-2"></i>
                Auf Updates prüfen
            </button>
            
            <button id="apply-updates" 
                    class="btn btn-success hidden">
                <i class="fas fa-download mr-2"></i>
                Update durchführen
            </button>
        </div>
        
        <div id="update-log" class="mt-6 hidden">
            <h3 class="text-lg font-semibold mb-2">Update-Log</h3>
            <pre class="bg-gray-100 p-4 rounded-lg overflow-x-auto"></pre>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const checkButton = document.getElementById('check-updates');
    const applyButton = document.getElementById('apply-updates');
    const statusDiv = document.getElementById('update-status');
    const logDiv = document.getElementById('update-log');
    const logPre = logDiv.querySelector('pre');
    
    // Status aktualisieren
    function updateStatus(message, type = 'info') {
        statusDiv.innerHTML = `
            <p class="text-${type === 'error' ? 'red' : type === 'success' ? 'green' : 'gray'}-600">
                ${message}
            </p>
        `;
    }
    
    // Log aktualisieren
    function updateLog(message) {
        logDiv.classList.remove('hidden');
        logPre.textContent += message + '\n';
    }
    
    // Auf Updates prüfen
    checkButton.addEventListener('click', async function() {
        updateStatus('Prüfe auf Updates...');
        logDiv.classList.add('hidden');
        
        try {
            const response = await fetch('/admin/updates/check', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            const data = await response.json();
            
            if (data.status === 'success') {
                if (data.updates_available) {
                    updateStatus(`${data.commits_behind} Updates verfügbar`, 'success');
                    applyButton.classList.remove('hidden');
                } else {
                    updateStatus('Keine Updates verfügbar', 'info');
                    applyButton.classList.add('hidden');
                }
            } else {
                updateStatus('Fehler beim Prüfen der Updates: ' + data.message, 'error');
            }
        } catch (error) {
            updateStatus('Fehler beim Prüfen der Updates: ' + error.message, 'error');
        }
    });
    
    // Update durchführen
    applyButton.addEventListener('click', async function() {
        if (!confirm('Möchten Sie das Update jetzt durchführen?')) {
            return;
        }
        
        updateStatus('Update wird durchgeführt...');
        applyButton.disabled = true;
        checkButton.disabled = true;
        logDiv.classList.remove('hidden');
        logPre.textContent = '';
        
        try {
            const response = await fetch('/admin/updates/apply', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            const data = await response.json();
            
            if (data.status === 'success') {
                updateStatus('Update erfolgreich durchgeführt', 'success');
                updateLog(data.message);
            } else {
                updateStatus('Fehler beim Update: ' + data.message, 'error');
                updateLog('Fehler: ' + data.message);
            }
        } catch (error) {
            updateStatus('Fehler beim Update: ' + error.message, 'error');
            updateLog('Fehler: ' + error.message);
        } finally {
            applyButton.disabled = false;
            checkButton.disabled = false;
        }
    });
    
    // Initial prüfen
    checkButton.click();
});
</script>
{% endblock %} 