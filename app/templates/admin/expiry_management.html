{% extends 'base.html' %}

{% block title %}Ablaufdatum-Verwaltung - Scandy{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold">Ablaufdatum-Verwaltung</h1>
        <a href="{{ url_for('admin.cleanup_expired') }}" class="btn btn-warning" 
           onclick="return confirm('Möchten Sie wirklich alle abgelaufenen Benutzer und Jobs löschen?')">
            <i class="fas fa-trash mr-2"></i>Abgelaufene Daten bereinigen
        </a>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} shadow-lg mb-4">
                    <div>
                        {% if category == 'success' %}<i class="fas fa-check-circle"></i>
                        {% elif category == 'error' %}<i class="fas fa-times-circle"></i>
                        {% else %}<i class="fas fa-info-circle"></i>{% endif %}
                        <span>{{ message }}</span>
                    </div>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- Statistiken -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <!-- Benutzer-Statistiken -->
        <div class="stat bg-base-100 shadow rounded-lg">
            <div class="stat-figure text-primary">
                <i class="fas fa-users text-3xl"></i>
            </div>
            <div class="stat-title">Benutzer</div>
            <div class="stat-value text-primary">{{ stats.users.total if stats.users else 0 }}</div>
            <div class="stat-desc">
                {% if stats.users %}
                    <span class="text-error">{{ stats.users.expired }} abgelaufen</span> • 
                    <span class="text-warning">{{ stats.users.soon_expiring }} bald ablaufend</span>
                {% endif %}
            </div>
        </div>

        <div class="stat bg-base-100 shadow rounded-lg">
            <div class="stat-figure text-secondary">
                <i class="fas fa-briefcase text-3xl"></i>
            </div>
            <div class="stat-title">Jobs</div>
            <div class="stat-value text-secondary">{{ stats.jobs.total if stats.jobs else 0 }}</div>
            <div class="stat-desc">
                {% if stats.jobs %}
                    <span class="text-error">{{ stats.jobs.expired }} abgelaufen</span> • 
                    <span class="text-warning">{{ stats.jobs.soon_expiring }} bald ablaufend</span>
                {% endif %}
            </div>
        </div>

        <div class="stat bg-base-100 shadow rounded-lg">
            <div class="stat-figure text-accent">
                <i class="fas fa-exclamation-triangle text-3xl"></i>
            </div>
            <div class="stat-title">Warnungen</div>
            <div class="stat-value text-accent">{{ warnings.total_warnings if warnings else 0 }}</div>
            <div class="stat-desc">In den nächsten 7 Tagen</div>
        </div>

        <div class="stat bg-base-100 shadow rounded-lg">
            <div class="stat-figure text-info">
                <i class="fas fa-clock text-3xl"></i>
            </div>
            <div class="stat-title">Letzte Bereinigung</div>
            <div class="stat-value text-info">-</div>
            <div class="stat-desc">Automatisch</div>
        </div>
    </div>

    <!-- Warnungen für bald ablaufende Accounts -->
    {% if warnings and warnings.total_warnings > 0 %}
    <div class="card bg-warning shadow-lg mb-6">
        <div class="card-body">
            <h2 class="card-title text-warning-content">
                <i class="fas fa-exclamation-triangle mr-2"></i>
                Warnungen - Bald ablaufende Accounts
            </h2>
            
            <!-- Benutzer-Warnungen -->
            {% if warnings.users %}
            <div class="mb-4">
                <h3 class="text-lg font-semibold mb-2">Benutzer</h3>
                <div class="overflow-x-auto">
                    <table class="table table-zebra w-full">
                        <thead>
                            <tr>
                                <th>Benutzername</th>
                                <th>Rolle</th>
                                <th>Ablaufdatum</th>
                                <th>Verbleibende Tage</th>
                                <th>Aktionen</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in warnings.users %}
                            <tr>
                                <td>{{ user.username }}</td>
                                <td>
                                    <span class="badge badge-{{ 'error' if user.role == 'admin' else 'warning' if user.role == 'mitarbeiter' else 'info' }}">
                                        {{ user.role }}
                                    </span>
                                </td>
                                <td>{{ user.expires_at.split('T')[0] if 'T' in user.expires_at else user.expires_at.split(' ')[0] }}</td>
                                <td>
                                    <span class="badge badge-warning">{{ user.days_left }} Tage</span>
                                </td>
                                <td>
                                    <a href="{{ url_for('admin.edit_user', user_id=user.id) }}" class="btn btn-sm btn-outline">
                                        <i class="fas fa-edit mr-1"></i>Bearbeiten
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}

            <!-- Job-Warnungen -->
            {% if warnings.jobs %}
            <div>
                <h3 class="text-lg font-semibold mb-2">Jobs</h3>
                <div class="overflow-x-auto">
                    <table class="table table-zebra w-full">
                        <thead>
                            <tr>
                                <th>Titel</th>
                                <th>Firma</th>
                                <th>Ablaufdatum</th>
                                <th>Verbleibende Tage</th>
                                <th>Aktionen</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for job in warnings.jobs %}
                            <tr>
                                <td>{{ job.title }}</td>
                                <td>{{ job.company }}</td>
                                <td>{{ job.expires_at.split('T')[0] if 'T' in job.expires_at else job.expires_at.split(' ')[0] }}</td>
                                <td>
                                    <span class="badge badge-warning">{{ job.days_left }} Tage</span>
                                </td>
                                <td>
                                    <a href="{{ url_for('jobs.edit_job', job_id=job.id) }}" class="btn btn-sm btn-outline">
                                        <i class="fas fa-edit mr-1"></i>Bearbeiten
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Ablaufdatum-Einstellungen -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Benutzer-Verwaltung -->
        <div class="card bg-base-100 shadow-lg">
            <div class="card-body">
                <h2 class="card-title">
                    <i class="fas fa-users text-primary mr-2"></i>
                    Benutzer-Verwaltung
                </h2>
                <p class="text-base-content/70 mb-4">
                    Verwalten Sie Ablaufdaten für Benutzerkonten. Abgelaufene Konten werden automatisch deaktiviert.
                </p>
                <div class="card-actions">
                    <a href="{{ url_for('admin.manage_users') }}" class="btn btn-primary">
                        <i class="fas fa-cog mr-2"></i>Benutzer verwalten
                    </a>
                </div>
            </div>
        </div>

        <!-- Job-Verwaltung -->
        <div class="card bg-base-100 shadow-lg">
            <div class="card-body">
                <h2 class="card-title">
                    <i class="fas fa-briefcase text-secondary mr-2"></i>
                    Job-Verwaltung
                </h2>
                <p class="text-base-content/70 mb-4">
                    Verwalten Sie Ablaufdaten für Jobanzeigen. Abgelaufene Jobs werden automatisch deaktiviert.
                </p>
                <div class="card-actions">
                    <a href="{{ url_for('jobs.job_list') }}" class="btn btn-secondary">
                        <i class="fas fa-list mr-2"></i>Jobs anzeigen
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Automatische Bereinigung -->
    <div class="card bg-base-100 shadow-lg mt-6">
        <div class="card-body">
            <h2 class="card-title">
                <i class="fas fa-robot text-accent mr-2"></i>
                Automatische Bereinigung
            </h2>
            <p class="text-base-content/70 mb-4">
                Das System kann automatisch abgelaufene Benutzerkonten und Jobs löschen. 
                Diese Funktion sollte regelmäßig ausgeführt werden.
            </p>
            <div class="alert alert-info">
                <div>
                    <i class="fas fa-info-circle"></i>
                    <span>
                        <strong>Hinweis:</strong> Admin-Benutzer werden bei der automatischen Bereinigung nicht gelöscht, 
                        auch wenn sie abgelaufen sind.
                    </span>
                </div>
            </div>
            <div class="card-actions">
                <button class="btn btn-warning" onclick="runCleanup()">
                    <i class="fas fa-trash mr-2"></i>Jetzt bereinigen
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function runCleanup() {
    if (confirm('Möchten Sie wirklich alle abgelaufenen Benutzer und Jobs löschen? Diese Aktion kann nicht rückgängig gemacht werden.')) {
        window.location.href = "{{ url_for('admin.cleanup_expired') }}";
    }
}

// Auto-Refresh der Statistiken alle 5 Minuten
setInterval(function() {
    fetch("{{ url_for('admin.api_expiry_statistics') }}")
        .then(response => response.json())
        .then(data => {
            // Update Statistiken (vereinfacht)
            console.log('Statistiken aktualisiert:', data);
        })
        .catch(error => {
            console.error('Fehler beim Aktualisieren der Statistiken:', error);
        });
}, 300000); // 5 Minuten
</script>
{% endblock %} 