{% extends "base.html" %}

{% block title %}Ticket #{{ ticket.id }}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Header mit Ticket-ID und Status -->
    <div class="flex items-center mb-6">
        <a href="{{ url_for('admin.tickets') }}" class="btn btn-ghost btn-sm mr-4">
            <i class="fas fa-arrow-left"></i>
        </a>
        <h1 class="text-2xl font-bold">Ticket #{{ ticket.id }}</h1>
        <span class="badge badge-{{ 
            'success' if ticket.status == 'gelöst' 
            else 'warning' if ticket.status == 'in_bearbeitung' 
            else 'error' 
        }} ml-4">
            {{ ticket.status }}
        </span>
        <div class="ml-auto">
            <button onclick="deleteTicket({{ ticket.id }})" class="btn btn-error btn-sm">
                <i class="fas fa-trash mr-2"></i>
                Ticket löschen
            </button>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Ticket Details -->
        <div class="lg:col-span-2">
            <!-- Hauptinformationen -->
            <div class="card bg-base-100 shadow-xl mb-6">
                <div class="card-body">
                    <h2 class="card-title">{{ ticket.title }}</h2>
                    <div class="divider"></div>
                    <p class="whitespace-pre-wrap">{{ ticket.description }}</p>
                </div>
            </div>

            <!-- Antworten und Kommunikation -->
            <div class="card bg-base-100 shadow-xl mb-6">
                <div class="card-body">
                    <h3 class="font-bold mb-4">
                        <i class="fas fa-comments text-primary mr-2"></i>
                        Kommunikation
                    </h3>
                    
                    <!-- Nachrichtenverlauf -->
                    <div class="space-y-4 mb-6">
                        {% if messages %}
                            {% for message in messages %}
                            <div class="chat {{ 'chat-end' if message.is_admin else 'chat-start' }}">
                                <div class="chat-header">
                                    {{ message.sender }}
                                    <time class="text-xs opacity-50">{{ message.created_at }}</time>
                                </div>
                                <div class="chat-bubble {{ 'chat-bubble-primary' if message.is_admin else 'chat-bubble-secondary' }}">
                                    {{ message.message }}
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-base-content/60">Noch keine Nachrichten vorhanden.</p>
                        {% endif %}
                    </div>

                    <!-- Neue Nachricht -->
                    <form id="messageForm" class="mt-4">
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Neue Nachricht</span>
                            </label>
                            <textarea name="message" class="textarea textarea-bordered h-24" 
                                    placeholder="Ihre Nachricht hier..."></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary mt-4">
                            <i class="fas fa-paper-plane mr-2"></i>
                            Nachricht senden
                        </button>
                    </form>
                </div>
            </div>

            <!-- Notizen Historie -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h3 class="font-bold mb-4">
                        <i class="fas fa-history text-primary mr-2"></i>
                        Notizen Historie
                    </h3>
                    {% if notes %}
                        {% for note in notes %}
                        <div class="mb-4 last:mb-0">
                            <div class="flex justify-between items-start mb-2">
                                <span class="font-medium">{{ note.created_by }}</span>
                                <span class="text-sm text-base-content/60">{{ note.created_at }}</span>
                            </div>
                            <p class="whitespace-pre-wrap">{{ note.note }}</p>
                            {% if note.is_private %}
                            <div class="badge badge-warning mt-2">
                                <i class="fas fa-lock mr-1"></i>
                                Private Notiz
                            </div>
                            {% endif %}
                            <div class="divider"></div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-base-content/60">Noch keine Notizen vorhanden.</p>
                    {% endif %}
                </div>
            </div>

            <!-- Auftragsdetails und Materialliste -->
            <div class="card bg-base-100 shadow-xl mb-6">
                <div class="card-body">
                    <h3 class="font-bold mb-4">
                        <i class="fas fa-clipboard-list text-primary mr-2"></i>
                        Auftragsdetails
                    </h3>
                    <form method="POST" action="{{ url_for('tickets.update', id=ticket.id) }}" id="auftragDetailsForm">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="label"><span class="label-text">Bereich</span></label>
                                <input type="text" name="bereich" class="input input-bordered w-full" value="{{ auftrag_details.bereich if auftrag_details else '' }}">
                            </div>
                            <div>
                                <label class="label"><span class="label-text">Fertigstellungstermin</span></label>
                                <input type="date" name="fertigstellungstermin" class="input input-bordered w-full" value="{{ auftrag_details.fertigstellungstermin if auftrag_details else '' }}">
                            </div>
                            <div>
                                <label class="label"><span class="label-text">Auftraggeber</span></label>
                                <label class="cursor-pointer mr-4">
                                    <input type="checkbox" name="auftraggeber_intern" value="1" class="checkbox" {% if auftrag_details and auftrag_details.auftraggeber_intern %}checked{% endif %}>
                                    <span class="ml-2">Intern</span>
                                </label>
                                <label class="cursor-pointer">
                                    <input type="checkbox" name="auftraggeber_extern" value="1" class="checkbox" {% if auftrag_details and auftrag_details.auftraggeber_extern %}checked{% endif %}>
                                    <span class="ml-2">Extern</span>
                                </label>
                            </div>
                            <div>
                                <label class="label"><span class="label-text">Name Auftraggeber</span></label>
                                <input type="text" name="auftraggeber_name" class="input input-bordered w-full" value="{{ auftrag_details.auftraggeber_name if auftrag_details else '' }}">
                            </div>
                            <div class="md:col-span-2">
                                <label class="label"><span class="label-text">Kontakt</span></label>
                                <input type="text" name="kontakt" class="input input-bordered w-full" value="{{ auftrag_details.kontakt if auftrag_details else '' }}">
                            </div>
                            <div class="md:col-span-2">
                                <label class="label"><span class="label-text">Auftragsbeschreibung</span></label>
                                <textarea name="auftragsbeschreibung" class="textarea textarea-bordered w-full h-24">{{ auftrag_details.auftragsbeschreibung if auftrag_details else '' }}</textarea>
                            </div>
                        </div>
                        <div class="divider my-6">Materialliste</div>
                        <div id="materialList">
                            <table class="table w-full">
                                <thead>
                                    <tr>
                                        <th>Material</th>
                                        <th>Menge</th>
                                        <th>Einzelpreis (€)</th>
                                        <th>Gesamtpreis (€)</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="materialRows">
                                    {% if material_list %}
                                        {% for mat in material_list %}
                                        <tr>
                                            <td><input type="text" name="material" class="input input-bordered w-full" value="{{ mat.material }}"></td>
                                            <td><input type="number" name="menge" class="input input-bordered w-24" value="{{ mat.menge }}" min="0" step="any" onchange="updateSumme(this)"></td>
                                            <td><input type="number" name="einzelpreis" class="input input-bordered w-24" value="{{ mat.einzelpreis }}" min="0" step="any" onchange="updateSumme(this)"></td>
                                            <td><input type="text" name="gesamtpreis" class="input input-bordered w-32" value="{{ (mat.menge * mat.einzelpreis)|round(2) }}" readonly></td>
                                            <td><button type="button" class="btn btn-error btn-sm" onclick="removeMaterialRow(this)"><i class="fas fa-trash"></i></button></td>
                                        </tr>
                                        {% endfor %}
                                    {% else %}
                                        <tr>
                                            <td><input type="text" name="material" class="input input-bordered w-full"></td>
                                            <td><input type="number" name="menge" class="input input-bordered w-24" min="0" step="any" onchange="updateSumme(this)"></td>
                                            <td><input type="number" name="einzelpreis" class="input input-bordered w-24" min="0" step="any" onchange="updateSumme(this)"></td>
                                            <td><input type="text" name="gesamtpreis" class="input input-bordered w-32" readonly></td>
                                            <td><button type="button" class="btn btn-error btn-sm" onclick="removeMaterialRow(this)"><i class="fas fa-trash"></i></button></td>
                                        </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                            <button type="button" class="btn btn-secondary mt-2" onclick="addMaterialRow()"><i class="fas fa-plus"></i> Material hinzufügen</button>
                        </div>
                        <div class="flex justify-end mt-4">
                            <div class="font-bold mr-4">Summe Material:</div>
                            <div id="summeMaterial" class="font-bold">0,00 €</div>
                        </div>
                        <div class="flex justify-end mt-2">
                            <button type="submit" class="btn btn-primary">Speichern</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Meta Informationen -->
        <div class="lg:col-span-1">
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h3 class="font-bold mb-4">
                        <i class="fas fa-info-circle text-primary mr-2"></i>
                        Ticket Details
                    </h3>
                    
                    <div class="space-y-4">
                        <!-- Status -->
                        <div>
                            <span class="text-sm font-medium">Status</span>
                            <p class="badge badge-{{ 
                                'success' if ticket.status == 'gelöst' 
                                else 'warning' if ticket.status == 'in_bearbeitung' 
                                else 'error' 
                            }}">
                                {{ ticket.status }}
                            </p>
                        </div>

                        <!-- Priorität -->
                        <div>
                            <span class="text-sm font-medium">Priorität</span>
                            <p class="badge badge-{{ 
                                'error' if ticket.priority == 'dringend'
                                else 'warning' if ticket.priority == 'hoch'
                                else 'info' if ticket.priority == 'normal'
                                else 'ghost'
                            }}">
                                {{ ticket.priority }}
                            </p>
                        </div>

                        <!-- Kategorie -->
                        {% if ticket.category %}
                        <div>
                            <span class="text-sm font-medium">Kategorie</span>
                            <p>{{ ticket.category }}</p>
                        </div>
                        {% endif %}

                        <!-- Erstellt von -->
                        <div>
                            <span class="text-sm font-medium">Erstellt von</span>
                            <p>{{ ticket.created_by }}</p>
                        </div>

                        <!-- Erstellt am -->
                        <div>
                            <span class="text-sm font-medium">Erstellt am</span>
                            <p>{{ ticket.created_at }}</p>
                        </div>

                        <!-- Zugewiesen an -->
                        <div>
                            <span class="text-sm font-medium">Zugewiesen an</span>
                            <p>{{ ticket.assigned_to or 'Nicht zugewiesen' }}</p>
                        </div>

                        <!-- Fälligkeitsdatum -->
                        {% if ticket.due_date %}
                        <div>
                            <span class="text-sm font-medium">Fällig am</span>
                            <p class="{{ 'text-error' if ticket.due_date < now and ticket.status not in ['gelöst', 'erledigt'] }}">
                                {{ ticket.due_date }}
                            </p>
                        </div>
                        {% endif %}

                        <!-- Gelöst am -->
                        {% if ticket.resolved_at %}
                        <div>
                            <span class="text-sm font-medium">Gelöst am</span>
                            <p>{{ ticket.resolved_at }}</p>
                        </div>
                        {% endif %}

                        <!-- Letzte Änderung -->
                        {% if ticket.last_modified_by %}
                        <div>
                            <span class="text-sm font-medium">Letzte Änderung</span>
                            <p>Von {{ ticket.last_modified_by }} am {{ ticket.last_modified_at }}</p>
                        </div>
                        {% endif %}
                    </div>

                    <div class="divider"></div>
                    
                    <button onclick="document.getElementById('updateModal').showModal()" 
                            class="btn btn-primary w-full">
                        <i class="fas fa-edit mr-2"></i>
                        Ticket bearbeiten
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Update Modal -->
<dialog id="updateModal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg mb-4">Ticket bearbeiten</h3>
        <form id="updateForm" method="POST" action="{{ url_for('tickets.update', id=ticket.id) }}">
            <div class="form-control mb-4">
                <label class="label">
                    <span class="label-text">Status</span>
                </label>
                <select name="status" class="select select-bordered w-full" required>
                    <option value="offen" {% if ticket.status == 'offen' %}selected{% endif %}>
                        Offen
                    </option>
                    <option value="in_bearbeitung" {% if ticket.status == 'in_bearbeitung' %}selected{% endif %}>
                        In Bearbeitung
                    </option>
                    <option value="gelöst" {% if ticket.status == 'gelöst' %}selected{% endif %}>
                        Gelöst
                    </option>
                </select>
            </div>

            <div class="form-control mb-4">
                <label class="label">
                    <span class="label-text">Priorität</span>
                </label>
                <select name="priority" class="select select-bordered w-full" required>
                    <option value="niedrig" {% if ticket.priority == 'niedrig' %}selected{% endif %}>
                        Niedrig
                    </option>
                    <option value="normal" {% if ticket.priority == 'normal' %}selected{% endif %}>
                        Normal
                    </option>
                    <option value="hoch" {% if ticket.priority == 'hoch' %}selected{% endif %}>
                        Hoch
                    </option>
                    <option value="dringend" {% if ticket.priority == 'dringend' %}selected{% endif %}>
                        Dringend
                    </option>
                </select>
            </div>

            <div class="form-control mb-4">
                <label class="label">
                    <span class="label-text">Zugewiesen an</span>
                </label>
                <select name="assigned_to" class="select select-bordered w-full">
                    <option value="">Nicht zugewiesen</option>
                    {% for worker in workers %}
                    <option value="{{ worker.username }}" {% if ticket.assigned_to == worker.username %}selected{% endif %}>
                        {{ worker.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-control mb-4">
                <label class="label">
                    <span class="label-text">Fälligkeitsdatum</span>
                </label>
                <input type="datetime-local" name="due_date" class="input input-bordered w-full"
                       value="{{ ticket.due_date.strftime('%Y-%m-%dT%H:%M') if ticket.due_date else '' }}">
            </div>

            <div class="modal-action">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save mr-2"></i>
                    Speichern
                </button>
                <button type="button" class="btn" onclick="document.getElementById('updateModal').close()">
                    Abbrechen
                </button>
            </div>
        </form>
    </div>
</dialog>

<script>
function deleteTicket(id) {
    if (confirm('Möchten Sie dieses Ticket wirklich löschen?')) {
        fetch(`/tickets/${id}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.href = '/admin/tickets';
            } else {
                alert(data.message || 'Fehler beim Löschen des Tickets');
            }
        })
        .catch(error => {
            console.error('Fehler:', error);
            alert('Ein Fehler ist aufgetreten');
        });
    }
}

// Formular für Ticket-Updates
document.getElementById('updateForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = {
        status: formData.get('status'),
        priority: formData.get('priority'),
        assigned_to: formData.get('assigned_to'),
        due_date: formData.get('due_date')
    };
    
    fetch(this.action, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.reload();
        } else {
            alert(data.message || 'Fehler beim Speichern der Änderungen');
        }
    })
    .catch(error => {
        console.error('Fehler:', error);
        alert('Ein Fehler ist aufgetreten');
    });
});

// Formular für interne Notizen
document.getElementById('internalNoteForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = {
        resolution_notes: formData.get('resolution_notes')
    };
    
    fetch(`/tickets/{{ ticket.id }}/update`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.reload();
        } else {
            alert(data.message || 'Fehler beim Speichern der Notiz');
        }
    })
    .catch(error => {
        console.error('Fehler:', error);
        alert('Ein Fehler ist aufgetreten');
    });
});

// Formular für öffentliche Antworten
document.getElementById('responseForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = {
        response: formData.get('response')
    };
    
    fetch(`/tickets/{{ ticket.id }}/update`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.reload();
        } else {
            alert(data.message || 'Fehler beim Speichern der Antwort');
        }
    })
    .catch(error => {
        console.error('Fehler:', error);
        alert('Ein Fehler ist aufgetreten');
    });
});

// Nachrichtenformular
document.getElementById('messageForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = {
        message: formData.get('message')
    };
    
    fetch(`/tickets/{{ ticket.id }}/message`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.reload();
        } else {
            alert(data.message || 'Fehler beim Senden der Nachricht');
        }
    })
    .catch(error => {
        console.error('Fehler:', error);
        alert('Ein Fehler ist aufgetreten');
    });
});

function updateSumme(el) {
    const row = el.closest('tr');
    const menge = parseFloat(row.querySelector('input[name="menge"]').value) || 0;
    const einzelpreis = parseFloat(row.querySelector('input[name="einzelpreis"]').value) || 0;
    const gesamt = menge * einzelpreis;
    row.querySelector('input[name="gesamtpreis"]').value = gesamt.toFixed(2);
    updateSummeMaterial();
}
function updateSummeMaterial() {
    let summe = 0;
    document.querySelectorAll('#materialRows tr').forEach(row => {
        const gesamt = parseFloat(row.querySelector('input[name="gesamtpreis"]').value) || 0;
        summe += gesamt;
    });
    document.getElementById('summeMaterial').innerText = summe.toFixed(2) + ' €';
}
function addMaterialRow() {
    const tbody = document.getElementById('materialRows');
    const tr = document.createElement('tr');
    tr.innerHTML = `
        <td><input type="text" name="material" class="input input-bordered w-full"></td>
        <td><input type="number" name="menge" class="input input-bordered w-24" min="0" step="any" onchange="updateSumme(this)"></td>
        <td><input type="number" name="einzelpreis" class="input input-bordered w-24" min="0" step="any" onchange="updateSumme(this)"></td>
        <td><input type="text" name="gesamtpreis" class="input input-bordered w-32" readonly></td>
        <td><button type="button" class="btn btn-error btn-sm" onclick="removeMaterialRow(this)"><i class="fas fa-trash"></i></button></td>
    `;
    tbody.appendChild(tr);
}
function removeMaterialRow(btn) {
    btn.closest('tr').remove();
    updateSummeMaterial();
}
document.addEventListener('DOMContentLoaded', updateSummeMaterial);
document.querySelectorAll('input[name="menge"], input[name="einzelpreis"]').forEach(input => {
    input.addEventListener('input', function() { updateSumme(this); });
});
</script>

{% endblock %} 